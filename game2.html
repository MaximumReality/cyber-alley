<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maximum Reality: Cyber Alley</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; position: fixed; width: 100%; height: 100%; -webkit-user-select: none; user-select: none; }
        #gameCanvas { display: block; width: 100vw; height: 100vh; image-rendering: pixelated; }
        .ui-layer { position: absolute; top: 20px; left: 20px; color: #0ff; text-shadow: 0 0 10px #0ff; z-index: 10; pointer-events: none; }
        .game-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 15px; z-index: 100; }
        .game-controls button { background: rgba(0, 255, 255, 0.1); border: 1px solid #0ff; color: #0ff; padding: 8px; border-radius: 5px; }
        #recentMenu { position: absolute; top: 80px; left: 20px; display: flex; gap: 8px; height: 40px; }
        #recentMenu img { width: 40px; height: 40px; border: 1px solid #0ff; background: rgba(0,255,255,0.1); border-radius: 4px; }
        #overlay-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200; }
        #loader-container { width: 250px; height: 12px; border: 1px solid #0ff; padding: 3px; margin-bottom: 20px; }
        #loader-bar { width: 0%; height: 100%; background: #0ff; box-shadow: 0 0 15px #0ff; transition: width 0.2s; }
        #start-btn { display: none; background: transparent; border: 2px solid #0ff; color: #0ff; padding: 15px 35px; font-size: 22px; cursor: pointer; box-shadow: 0 0 15px #0ff; text-transform: uppercase; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <audio id="bgMusic" loop><source src="https://maximumreality.github.io/cyber-alley/futuristic-cyberpunk-industrial-music.mp3" type="audio/mpeg"></audio>
    <div id="overlay-screen">
        <div id="loader-container"><div id="loader-bar"></div></div>
        <button id="start-btn" onclick="startGame()">CONNECT TO REALITY</button>
    </div>
    <div class="ui-layer">
        <div id="scoreDisplay">SCORE: 0</div>
        <div id="status">INITIALIZING...</div>
    </div>
    <div id="recentMenu"></div>
    <div class="game-controls">
        <button onclick="location.reload()">üè†</button>
        <button id="muteBtn" onclick="toggleMute()">üîä</button>
    </div>
    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const BASE_URL = "https://maximumreality.github.io/cyber-alley/";
const music = document.getElementById('bgMusic');

// --- ASSETS ---
const toLoad = ['gg-bg.png', 'building-a.png', 'building-b.png', 'building-c.png', 'building-d.png', 'building-e.png', 'building-f.png', 'floor.png'];
const loriSprites = ['Lori-run.png', 'Lori-run2.png', 'Lori-run3.png'];
const azulSprites = ['Azul-run.png', 'Azul-run2.png', 'Azul-run3.png'];
const mochkilSprites = ['Mochkil.png', 'Mochkil2.png'];

const assets = {};
let loadedCount = 0;
const allAssets = [...toLoad, ...loriSprites, ...azulSprites, ...mochkilSprites];

// --- FAIL-SAFE LOADER ---
function load() {
    // Force start after 5 seconds even if assets fail
    setTimeout(() => {
        if (gameState === 'LOADING') {
            console.log("Force starting due to timeout...");
            showStartButton();
        }
    }, 5000);

    allAssets.forEach(src => {
        const img = new Image();
        img.onload = () => {
            loadedCount++;
            document.getElementById('loader-bar').style.width = (loadedCount / allAssets.length * 100) + "%";
            if (loadedCount >= allAssets.length) showStartButton();
        };
        img.onerror = () => {
            loadedCount++; // Skip broken images so game doesn't hang
            if (loadedCount >= allAssets.length) showStartButton();
        };
        img.src = BASE_URL + src;
        assets[src] = img;
    });
}

function showStartButton() {
    const btn = document.getElementById('start-btn');
    if (btn) btn.style.display = 'block';
    document.getElementById('status').innerText = "SYSTEM ONLINE";
}

// --- STABLE DRAWING FUNCTIONS ---
function drawFloor() {
    if (!assets['floor.png'] || !assets['floor.png'].complete) return;
    for (let i = 0; i < (canvas.width / 50) + 2; i++) {
        ctx.drawImage(assets['floor.png'], (-(frame * 6) % 50) + (i * 50), canvas.height - GROUND_HEIGHT, 50, GROUND_HEIGHT);
    }
}

function drawCity() {
    const bSet = currentBiome === 'night' ? ['building-c.png', 'building-b.png', 'building-a.png'] : ['building-f.png', 'building-e.png', 'building-d.png'];
    bSet.forEach((src, i) => {
        if (assets[src] && assets[src].complete) {
            ctx.globalAlpha = 0.3 + (i * 0.2);
            let xPos = -(frame * (0.5 + i * 0.5)) % canvas.width;
            ctx.drawImage(assets[src], xPos, canvas.height - GROUND_HEIGHT - 400, canvas.width, 400);
            ctx.drawImage(assets[src], xPos + canvas.width, canvas.height - GROUND_HEIGHT - 400, canvas.width, 400);
        }
    });
    ctx.globalAlpha = 1;
}

// --- UPDATED RESET (NO GHOSTS) ---
function resetGame() {
    gameObjects = []; // Kill all old obstacles immediately
    score = 0;
    frame = 0;
    jumpHeight = 0;
    jumpCount = 0;
    hasQuantumShield = true;
    snackStreak = 0;
    gameState = 'PLAYING';
    document.getElementById('status').innerText = "SYSTEM ACTIVE";
    music.play().catch(() => {});
}

// --- CORE ANIMATION LOOP ---
function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Always draw Background
    ctx.fillStyle = currentBiome === 'night' ? "#1a0033" : "#4b0082";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Always draw Stars
    ctx.fillStyle = "#fff";
    stars.forEach(s => {
        let sx = (s.x - (frame * 0.1)) % canvas.width;
        if (sx < 0) sx += canvas.width;
        ctx.globalAlpha = s.opacity;
        ctx.fillRect(sx, s.y, s.size, s.size);
    });
    ctx.globalAlpha = 1;

    if (gameState === 'PLAYING') {
        frame++;
        drawCity();
        drawFloor();
        
        // Physics
        if (frame % 100 === 0) gameObjects.push(new GameObject(Math.random() > 0.4 ? 'obstacle' : 'snack'));
        if (jumpCount > 0) {
            jumpHeight -= yVelocity;
            yVelocity += 1.2;
            if (jumpHeight <= 0) { jumpHeight = 0; jumpCount = 0; }
        }
        
        gameObjects.forEach((obj, i) => {
            obj.update();
            if (obj.x < -300) gameObjects.splice(i, 1);
        });
    }

    // Always draw Team
    lori.draw(); azul.draw(); mochkil.draw();

    if (gameState === 'GAMEOVER') {
        ctx.fillStyle = "rgba(0,0,0,0.8)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#0ff";
        ctx.textAlign = "center";
        ctx.font = "20px Courier";
        ctx.fillText("CONNECTION LOST", canvas.width/2, canvas.height/2);
        ctx.fillText("TAP TO RECONNECT", canvas.width/2, canvas.height/2 + 40);
    }
    
    requestAnimationFrame(animate);
}

// Start everything
load();
animate();
</script>

</body>
</html>
